# Install BigBlueButton 
Requirement 
```sh 
Ubuntu 16.04 64-bits OS version
4 GB of free memory with swap enabled (8 GB of memory is better)
Quad-core 2.6 GHZ CPU (or faster)
TCP ports 80, 443, and 1935 are accessible
TCP port 7443 is accessible if you intend to configure SSL (recommended), otherwise, port 5066 is accessible
UDP ports 16384 - 32768 are accessible
Port 80 is not used by another application
500 GB of free disk for recording for physical server but you can have at least 40GB for a virtual server
100 Mbps of bandwidth which must be symmetrical.
```

Update locale 
```sh 
apt install -y language-pack-en && update-locale LANG=en_US.UTF-8
```

Kiểm tra 
```sh 
cat /etc/default/locale
```

Kết quả 
```sh 
root@ubuntu:~# cat /etc/default/locale
#  File generated by update-locale
LANG=en_US.UTF-8
```

Cài đặt tools kiểm tra VM/Server?
```sh 
apt install -y facter
```

Kiểm tra 
```sh 
facter 2> /dev/null | grep virtual
```

Kết quả 
```sh 
root@ubuntu:~# facter 2> /dev/null | grep virtual
is_virtual => true
virtual => kvm
```

Đối với VM cần cài thêm `haveged` để cải thiện entropy khi sử dụng Tomcat 
```sh 
apt install -y haveged
```

Bổ sung key yq và setup 
```sh 
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 6657DBE0CC86BB64
sudo apt update
wget -qO- https://ubuntu.bigbluebutton.org/bbb-install.sh | bash -s -- -v xenial-220 -a
```

Remove bbb-demo
```sh 
apt-get purge bbb-demo
```

Restart bb sau khi cài đặt 
```sh 
bbb-conf --restart
```

# Install Greenlight themes

## Install Docker 
Update
```sh 
sudo apt-get update -y
```

Cho phép apt sử dụng https 
```sh 
sudo apt-get -y install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common
```

Thêm Docker’s official GPG key:
```sh 
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
```

Kiểm tra 
```sh 
sudo apt-key fingerprint 0EBFCD88
```

Kết quả 
```sh 
root@ubuntu:~# curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
OK
root@ubuntu:~# sudo apt-key fingerprint 0EBFCD88
pub   4096R/0EBFCD88 2017-02-22
      Key fingerprint = 9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88
uid                  Docker Release (CE deb) <docker@docker.com>
sub   4096R/F273FCD8 2017-02-22
```

Add repo 
```sh 
sudo add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable"
```

Update 
```sh 
sudo apt-get update -y
```

Install Docker 
```sh 
sudo apt-get -y install docker-ce docker-ce-cli containerd.io 
```

Kiểm tra 
```sh 
docker -v
```

Kết quả 
```sh 
root@ubuntu:~# docker -v
Docker version 19.03.8, build afacb8b7f0
```

Cài đặt docker-compose 
```sh 
sudo curl -L "https://github.com/docker/compose/releases/download/1.25.4/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
```

Kiểm tra 
```sh 
docker-compose --version
```

Kết quả 
```sh 
root@ubuntu:~# docker-compose --version
docker-compose version 1.25.4, build 8d51620a
```
> # Snapshot VM 

## Cài đặt Greenlight 2.0 

Tạo thư mục để chứa các config 
```sh 
mkdir ~/greenlight && cd ~/greenlight
```

Pool images `bigbluebutton/greenlight:v2`
```sh 
docker pull bigbluebutton/greenlight:v2
docker pull postgres:9.5
```

Greenlight sẽ đọc cấu hình .env trong folder `~/greenlight`. Để tạo ra file .env mặc định chúng ta thực hiện 
```sh 
docker run --rm bigbluebutton/greenlight:v2 cat ./sample.env > .env
```

Generating cấu hình secretkey cho Greenlight 
```sh 
docker run --rm bigbluebutton/greenlight:v2 bundle exec rake secret
```

Kết quả 
```sh 
root@ubuntu:~/greenlight# docker run --rm bigbluebutton/greenlight:v2 bundle exec rake secret
7966bac6381007662a9281062d9d0510a01bbb54a3746cbdce2cd5c61fda58acc206163ac4a52c0455d4e1182abeea3c3dc66d4ce4b741c9d2695e60c413c04f
```

Cấu hình secret key vừa gen phía trên vào `SECRET_KEY_BASE` của file .env


Cấu hình xác thực giữa BBB và Greenlight
```sh 
sudo bbb-conf --secret
```

Kết quả 
```sh 
root@ubuntu:~/greenlight# sudo bbb-conf --secret

  URL: http://10.10.30.155/bigbluebutton/
  Secret: 3e2ac3b7d5b85d3582afcac40b63c18d
```

Cấu hình file `/root/greenlight/.env` 2 tham số trên `BIGBLUEBUTTON_ENDPOINT`, `BIGBLUEBUTTON_SECRET`

Kết quả 
![](bbb.png)


Kiểm tra config 
```sh 
docker run --rm --env-file .env bigbluebutton/greenlight:v2 bundle exec rake conf:check
```

Kết quả kết nối thành công 
```sh 
root@ubuntu:~/greenlight# docker run --rm --env-file .env bigbluebutton/greenlight:v2 bundle exec rake conf:check

Checking environment: Passed
Checking Connection: Passed
Checking Secret: Passed
```

Greenlight sẽ hoạt động trên `/b` để tránh xung đột các thành phần khác. Gen file cấu hình của NGINX
```sh 
docker run --rm bigbluebutton/greenlight:v2 cat ./greenlight.nginx | sudo tee /etc/bigbluebutton/nginx/greenlight.nginx
```

Kiểm tra 
```sh 
cat /etc/bigbluebutton/nginx/greenlight.nginx
```

Restart NGINX 
```sh 
sudo systemctl restart nginx
```

Cấu hình để nginx mặc định sử dụng Greenlight. Bổ sung cuối file config `/etc/nginx/sites-available/bigbluebutton` ngay trước dấu `}` cuối cùng 
```sh 
location = / {
  return 307 /b;
}
```

![](bbb2.png)

Restart NGINX 
```sh 
sudo systemctl restart nginx
```

Khởi tạo file docker-compose
```sh 
docker run --rm bigbluebutton/greenlight:v2 cat ./docker-compose.yml > docker-compose.yml
```

Random gen password cho PostgreSQL
```sh 
export pass=$(openssl rand -hex 8); sed -i 's/POSTGRES_PASSWORD=password/POSTGRES_PASSWORD='$pass'/g' docker-compose.yml;sed -i 's/DB_PASSWORD=password/DB_PASSWORD='$pass'/g' .env
```

Start GreenLight 
```sh 
docker-compose up -d
```

Lưu ý: 
- Database lưu tại `~/greenlight/db`
- Thư mục log `~/greenlight/log`

Cấu hình để docker tự động start mỗi lần restart máy. Chỉnh config trong `docker-compose.yml` ở mỗi services 
```sh 
restart: always 
```

![](bbb2.5.png)

Hoàn tất cài đặt 

> # Snapshot VM 

# Cấu hình tài khoản quản trị 

Tạo tài khoản thường 
```sh 
docker exec greenlight-v2 bundle exec rake user:create["name","email","password","user"]
```

Tạo tài khoản admin 
```sh 
docker exec greenlight-v2 bundle exec rake user:create["name","email","password","admin"]
```

Disable đăng ký tài khoản mới trên giao diện bằng cách chỉnh sửa cấu hình file `/root/greenlight/.env` 
```sh 
sed -Ei "s|ALLOW_GREENLIGHT_ACCOUNTS=true|ALLOW_GREENLIGHT_ACCOUNTS=false|g" /root/greenlight/.env
cd /root/greenlight 
docker-compose down
docker-compose up -d
```

![](https://i.imgur.com/QRKrMDR.png)


Đăng nhập bằng tài khoản có roles Admin 

![](https://i.imgur.com/55NgSzP.png)

![](https://i.imgur.com/rrERApr.png)



# Sử dụng let's encrypt cho server BBB của dịch vụ Cloud365 
Mặc định sau khi cài đặt. BBB chỉ hỗ trợ trên nền tảng HTTP và không sử dụng được các tính năng như Micro, Webcam 

Để có thể sử dụng được các tính năng này chúng ta sẽ cấu hình BBB sử dụng HTTPS và dùng Let's Encrypt 

https://docs.bigbluebutton.org/2.2/install.html

Cloud365 team đã đơn giản hóa việc cài đặt HTTPS cho phiên bản BBB 2.2 bằng script 

- Cấu hình nhanh HTTPS với Let's cho Server BBB 
- Kiểm tra domain đã trỏ về server hay chưa trước khi chạy 
- Thời gian cấu hình khoảng 1-2p 
- Hỗ trợ redirect HTTP về HTTPS và non-domain về domain 

Thao tác trỏ domain về server 
![](bbb-1.png)

Kiểm tra bằng MXtoolbox 
![](bbb-2.png)

Sau khi trỏ thành công thực hiện cấu hình bằng đăng nhập vào Server đã cài đặt trên Cloud365

Cài đặt certbot
```sh 
sudo apt-get update
sudo apt-get install software-properties-common
sudo add-apt-repository universe
sudo add-apt-repository ppa:certbot/certbot
sudo apt-get install certbot
```

Thực hiện cấu hình HTTPS cho server sử dụng let's
```sh 
cd /root
wget https://scripts.cloud365.vn/bbb-letcert.sh
bash bbb-letcert.sh cloud365.thanhbaba.xyz 
```

Log thao tác 
https://paste.cloud365.vn/?c0ba64d4f5a3952d#5vZjbgWvUwXBXE7sdtiO6OHEcTMcyXqYey8NUZr/a44=

Truy cập bằng IP hoặc domain vừa vấu hình
![](bbb-let.gif)


# Xử lý cloud-init 

Cloud-init 
```sh 
#cloud-config
password: nhanhoa@2020
chpasswd: { expire: False }
ssh_pwauth: True
runcmd:
  - curl https://scripts.cloud365.vn/bbb-v2.sh -o /tmp/bbb.sh 
  - chmod +x /tmp/bbb.sh
  - bash /tmp/bbb.sh && rm -f /tmp/bbb.sh
```

# Tài liệu tham khảo 
https://linoxide.com/tools/install-bigbluebutton-webconferencing-ubuntu-16/
http://docs.bigbluebutton.org/2.2/install.html#Install_
http://docs.bigbluebutton.org/greenlight/gl-install.html#1-install-docker
https://docs.bigbluebutton.org/greenlight/gl-admin.html#creating-accounts